# 实时数据流管理工具使用说明

## 概述

这个交互式数据管理工具专门用于解决Flink实时数据流中sink端部分表没有数据的问题，并提供全面的数据管理功能。

## 问题分析

当前发现sink端有三张表没有数据：
- `ads_power_quality` (电力质量分析表)
- `ads_risk_assessment` (风险评估表) 
- `ads_energy_efficiency` (能效分析表)

**可能原因：**
1. DWS层数据不足 - 这些ADS表依赖于DWS层的聚合数据
2. 时间窗口配置问题 - Flink作业可能需要足够的时间窗口来生成聚合数据
3. JOIN条件不匹配 - 数据关联条件可能存在问题
4. 数据量不足 - Source端数据量可能不足以触发聚合计算

## 工具功能

### 1. Source端数据操作
- 查看数据统计
- 手动插入设备信息
- 插入电力消耗数据
- 插入告警记录
- 更新设备状态
- 删除过期数据

### 2. 自动生成测试数据
- 可配置生成时长（分钟）
- 可配置每分钟记录数
- 可配置设备数量
- 自动生成电力消耗和告警数据

### 3. Sink端数据监控
- 实时监控所有ADS表数据变化
- 单次查询数据统计
- 显示最新数据时间

### 4. 数据流延迟分析
- 分析Source到Sink的数据传输延迟
- 检查无数据表的可能原因
- 验证DWS层依赖表状态

### 5. 表结构查看
- 查看Source端表结构
- 查看Sink端表结构

### 6. 清理测试数据
- 安全清理所有测试生成的数据

## 使用步骤

### 启动工具

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行工具
python3 interactive_data_manager.py
```

### 解决无数据问题的建议步骤

#### 步骤1：检查当前状态
1. 选择 `3. Sink端数据监控` → `2. 单次查询`
2. 查看哪些表有数据，哪些表没有数据
3. 选择 `4. 数据流延迟分析` 查看详细分析

#### 步骤2：生成足够的测试数据
1. 选择 `2. 自动生成测试数据`
2. 建议配置：
   - 生成时长：60分钟（确保有足够的历史数据）
   - 每分钟记录数：10-20条
   - 设备数量：10个
3. 这将生成大约6000-12000条记录

#### 步骤3：等待数据流处理
1. 数据生成后，等待5-10分钟让Flink处理
2. 选择 `3. Sink端数据监控` → `1. 实时监控`
3. 观察数据变化情况

#### 步骤4：手动补充特定数据
如果某些表仍然没有数据，可以手动添加：

1. **为ads_power_quality添加数据**：
   - 选择 `1. Source端数据操作` → `3. 插入电力消耗数据`
   - 输入异常的电压/电流值（如电压<200V或>250V）

2. **为ads_risk_assessment添加数据**：
   - 选择 `1. Source端数据操作` → `4. 插入告警记录`
   - 添加高级别告警（severity: high/critical）

3. **为ads_energy_efficiency添加数据**：
   - 确保有多个客户的设备数据
   - 生成不同类型的设备数据

## 监控和调试

### 实时监控
```bash
# 在工具中选择：3 → 1
# 这将每5秒刷新一次数据统计
```

### 检查依赖表
工具会自动检查以下DWS层表：
- `dws_equipment_hour_summary`
- `dws_customer_hour_power` 
- `dws_alert_hour_stats`

### 数据流延迟分析
工具会显示：
- Source端数据延迟
- Sink端数据延迟
- 管道处理延迟

## 常见问题解决

### Q1: 生成数据后仍然没有sink数据
**解决方案：**
1. 检查Flink作业是否正常运行
2. 增加数据生成的时长和频率
3. 等待更长时间（DWS层可能需要小时级聚合）

### Q2: 某些ADS表一直为空
**解决方案：**
1. 检查对应的DWS表是否有数据
2. 手动插入特定类型的数据触发计算
3. 检查Flink SQL中的JOIN条件

### Q3: 数据延迟很大
**解决方案：**
1. 检查Flink集群资源
2. 调整Flink作业的并行度
3. 检查数据库连接性能

## 数据生成策略

### 小规模测试
- 时长：10分钟
- 频率：5条/分钟
- 设备：5个
- 总计：250条记录

### 中等规模测试
- 时长：30分钟
- 频率：10条/分钟
- 设备：10个
- 总计：3000条记录

### 大规模测试
- 时长：120分钟
- 频率：20条/分钟
- 设备：20个
- 总计：48000条记录

## 安全注意事项

1. **清理测试数据**：使用工具的清理功能，需要输入'DELETE'确认
2. **生产环境**：不要在生产环境中运行大规模数据生成
3. **数据库连接**：确保数据库连接参数正确

## 技术细节

### 数据库连接
- Source: localhost:5442 (sgcc_source_db)
- Sink: localhost:5443 (sgcc_dw_db)

### 生成的测试数据格式
- 设备ID: TEST_EQ_001, TEST_EQ_002, ...
- 客户ID: CUST_001, CUST_002, ...
- 电压范围: 220-240V
- 电流范围: 1-50A
- 频率范围: 49.5-50.5Hz
- 告警概率: 10%

### 监控指标
- 记录数统计
- 最新数据时间
- 数据传输延迟
- 表状态（有数据✅/无数据❌）

## 联系支持

如果遇到问题，请检查：
1. Docker容器是否正常运行
2. 数据库连接是否正常
3. Flink作业状态
4. 工具的错误日志